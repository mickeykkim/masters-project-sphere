{% extends "base.html" %}

{% block style %}
.videoFrame{
  width:100%:
}
.videoFrame video {
  display: block;
  margin: 0 auto 10 10;
}
.videoControls {
  margin: 10 0 0 0
}
.controlButton {
  height:30px;
  width:70px;
  border-radius:6px;
}
.dropDown {
  height:21px;
  width:60px;
  border-radius:6px;
}
input[type=range] {
  -webkit-appearance: none;
  margin: 0 0;
  width: 100%;
}
input[type=range]:focus {
  outline: none;
}
input[type=range]::-webkit-slider-runnable-track {
  width: 100%;
  height: 5px;
  cursor: pointer;
  animate: 0.2s;
  box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
  background: #3071a9;
  border-radius: 1.3px;
  border: 0.2px solid #010101;
}
input[type=range]::-webkit-slider-thumb {
  box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
  border: 1px solid #000000;
  height: 30px;
  width: 10px;
  border-radius: 3px;
  background: #ffffff;
  cursor: pointer;
  -webkit-appearance: none;
  margin-top: -14px;
}
input[type=range]:focus::-webkit-slider-runnable-track {
  background: #367ebd;
}
{% endblock %}

{% block content %}
<h1>Patient: {{ cameradata.patient }} </h1>
<p>Session Time: {{ cameradata.time }}</p>

<!-- VideoFrame Object -->
<script src="https://rawgit.com/allensarkisyan/VideoFrame/master/VideoFrame.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<div class="videoFrame">
  <video
    name="{{ cameradata.patient }}"
    align="left" 
    height="50%"
    width="100%" 
    id="video" 
    src="{{ media_url }}{{ cameradata.filename }}" 
    type="video/mp4"
  ></video>

  <div id="controls" class="videoControls">
    <button id="play-pause" class="controlButton">Play</button>
    <input type="range" id="seek-bar" min="0" step="1" max="100" value="0" style="width:50%">
    <span id="videoTime">00:00</span> / <span id="videoDuration">00:00</span>
    <button id="mute"  class="controlButton">Mute</button>
    <input type="range" id="volume-bar" min="0" max="1" step="0.1" value="1" style="width:10%"></input>
    <br></br>
    <button id="seekBackward" class="controlButton"><i class="material-icons">skip_previous</i></button>
    <select class="dropDown">
      <option value="f1">1</option>
      <option value="f5">5</option>
      <option value="f10">10</option>
      <option value="f25">25</option>
      <option value="f50">50</option>
    </select>		
    <button id="seekForward" class="controlButton"><i class="material-icons">skip_next</i></button>
    <select class="dropDown">
      <option value="b1">1</option>
      <option value="b5">5</option>
      <option value="b10">10</option>
      <option value="b25">25</option>
      <option value="b50">50</option>
    </select>		
  </div>
</div>

<div class="frame">
  <br>
  Current Frame: <span id="currentFrame">0</span>
  <br>
  Current Time (hh:mm:ss:ff): <span id="currentTime">00:00:00:00</span>
</div>

<!-- Camera Annotation List -->
<div style="margin-left:20px;margin-top:20px">
  <h4>Camera Annotations</h4>
  <ul>
    {% for annotation in cameradata.cameraannotation_set.all %}
    <li><a href="{% url 'cameraannotation-detail' cameradata.id annotation.id %}">{{annotation.timestamp}} - {{annotation.get_annotation_display}}</a></li>
    {% endfor %}
  </ul>
</div>
{% endblock %}

{% block jquery %}

  var FrameRates = {
    film: 24,
    NTSC: 29.97,
    NTSC_Film: 23.98,
    NTSC_HD: 59.94,
    PAL: 25,
    PAL_HD: 50,
    web: 30,
    high: 60
  };

  var currentFrame = $('#currentFrame');
  var currentTime = $('#currentTime');
  var videoTime = document.getElementById("videoTime");
  var videoDuration = document.getElementById("videoDuration");
  
  // Video
  var video = VideoFrame({
    id : 'video',
    frameRate: FrameRates.NTSC,
    callback : function(frame) {
      currentFrame.html(video.get());
      currentTime.html(video.toSMPTE())
    }
  });

  // Buttons
  var playButton = document.getElementById("play-pause");
  var muteButton = document.getElementById("mute");
  var fullScreenButton = document.getElementById("full-screen");

  // Sliders
  var seekBar = document.getElementById("seek-bar");
  var volumeBar = document.getElementById("volume-bar");

  function playVideo() {
    video.video.play();
    video.listen('frame');
  }

  function pauseVideo() {
    video.video.pause();
    video.stopListen();
  }

  // Event listener for the play/pause button
  playButton.addEventListener("click", function() {
    if (video.video.paused == true) {
      playVideo();
      playButton.innerHTML = "Pause";
    } else {
      pauseVideo();
      playButton.innerHTML = "Play";
    }
  });

  // Event listener for the mute button
  muteButton.addEventListener("click", function() {
    if (video.video.muted == false) {
      video.video.muted = true;
      muteButton.innerHTML = "Unmute";
    } else {
      video.video.muted = false;
      muteButton.innerHTML = "Mute";
    }
  });

  function updateVideoTime() {
    // Calculate the new time
    var time = video.video.duration * (seekBar.value / 100);
    // Update the video time
    video.video.currentTime = time;
    // Update frame and time display
    currentFrame.html(video.get());
    currentTime.html(video.toSMPTE())
  }

  function updateSeekBar() {
    var value = (100 / video.video.duration) * video.video.currentTime;
    seekBar.value = value;
    var curMins = Math.floor(video.video.currentTime / 60);
    var curSecs = Math.floor(video.video.currentTime - curMins * 60);
    var durMins = Math.floor(video.video.duration / 60);
    var durSecs = Math.floor(video.video.duration - durMins * 60);
    if(curSecs < 10){ curSecs = "0" + curSecs; }
    if(durSecs < 10){ durSecs = "0" + durSecs; }
    if(curMins < 10){ curMins = "0" + curMins; }
    if(durMins < 10){ durMins = "0" + durMins; }
    videoTime.innerHTML = curMins + ":" + curSecs;
    videoDuration.innerHTML = durMins + ":" + durSecs;
  }

  // Event listener for the seek bar
  seekBar.addEventListener("change", function() {
    updateVideoTime();
  });

  // Update the seek bar as the video plays
  video.video.addEventListener("timeupdate", function() {
    updateSeekBar();
  });

  // Pause the video when the slider handle is being dragged
  seekBar.addEventListener("mousedown", function() {
    if (playButton.innerHTML === "Pause") {
      pauseVideo();
    }
    updateVideoTime();
  });

  // Play the video when the slider handle is dropped
  seekBar.addEventListener("change", function() {
    if (playButton.innerHTML === "Pause") {
      playVideo();
    }
  });

  // Event listener for the volume bar
  volumeBar.addEventListener("change", function() {
    video.video.volume = volumeBar.value;
  });

{% endblock %}